<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <title>JavaScript</title>
    <link rel="stylesheet" type="text/css" href="style.css" >
    <link rel="stylesheet" type="text/css" href="buttons.css" >
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=en_US" type="text/javascript"></script>
</head>
<body>
  <div id="buses_line">
    <input class="button button-rounded" type="button" value="Buses" onclick="sh_bus_num()" style="display: inline-block; margin-top: 12px; margin-left: 30px; "/>
      <button class="button button-rounded button-highlight" onclick="get_times('outbound')"
      style="display: inline-block; margin-top: 12px; margin-left: 30px; ">outbound</button>
      <button class="button button-rounded button-highlight" onclick="get_times('inbound')"
      style="display: inline-block; margin-top: 12px; margin-left: 5px; ">inbound</button>
      <div id="num_bus_div"><span></span><i>transport for London</i></div>
  </div>
    <div id="tab_times" style="position: fixed;">
      <table id="tab" border="1">
        <tr id="tr">
          <td onclick="openbox('box1'); return false">1-50</td>
          <td onclick="openbox('box2'); return false">51-100</td>
          <td onclick="openbox('box3'); return false">101-150</td>
          <td onclick="openbox('box4'); return false">151-200</td>
        </tr>
          <tr class="tr" id="box1" style="display: none;">
              <td colspan="4">
                <br /><a onclick="get_number(1)">1 </a><a onclick="get_number(2)"> 2 </a><a onclick="get_number(3)"> 3 </a>
                <a onclick="get_number(4)"> 4 </a><a onclick="get_number(5)"> 5 </a><a onclick="get_number(6)"> 6 </a>
                <a onclick="get_number(7)"> 7 </a><a onclick="get_number(8)"> 8 </a><a onclick="get_number(9)"> 9 </a>
                <a onclick="get_number(11)"> 11</a><br /><br />
                <a onclick="get_number(12)">12 </a><a onclick="get_number(13)"> 13 </a><a onclick="get_number(14)"> 14 </a><a onclick="get_number(15)"> 15 </a>
                <a onclick="get_number(16)"> 16 </a><a onclick="get_number(17)"> 17</a><a onclick="get_number(18)"> 18 </a><a onclick="get_number(19)"> 19 </a>
                <a onclick="get_number(20)"> 20 </a><a onclick="get_number(21)"> 21</a><br /><br />
                <a>22 </a><a> 23 </a><a> 24 </a><a> 25 </a>
                <a> 26 </a><a> 27</a><a> 28 </a><a> 29 </a>
                <a> 30 </a><a> 31</a><br /><br />
                <a>32 </a><a> 33 </a><a> 34 </a><a> 35 </a>
                <a> 36 </a><a> 37</a><a> 38 </a><a> 39 </a>
                <a> 40 </a><a> 41</a><br /><br />
                <a>42 </a><a> 43 </a><a> 44 </a><a> 45 </a>
                <a> 46 </a><a> 47</a><a> 48 </a><a> 49 </a>
                <a> 50</a><br /><br />
              </td>
          </tr>
          <tr class="tr" id="box2" style="display: none;">
            <td colspan="4">2</td>
          </tr>
          <tr class="tr" id="box3" style="display: none;">
            <td colspan="4">3</td>
          </tr>
          <tr class="tr" id="box4" style="display: none;">
            <td colspan="4">4</td>
          </tr>
        <tr id="tr">
          <td>201-250</td><td>251-300</td><td>301-350</td><td>351-400</td>
        </tr>
        <tr id="tr">
          <td>401-450</td><td>451-500</td><td>501-550</td><td>601-650</td>
        </tr>
        <tr id="tr">
          <td>651-700</td><td>951-1000</td>
        </tr>
        <tr id="tr">
          <td>A-D</td><td>E-K</td><td>N-S</td><td>U-X</td>
        </tr>
      </table>
    </div>
    <div id="times">
    </div>
    <div id="station" style="display: inline-block;"><p>Which bus are you looking for?</p></div>
    <div id="map" style="display: inline-block;"></div>

    <script type="text/javascript">
      var id_old;
      function openbox(id){
        display = document.getElementById(id).style.display;
        if(id_old != null){
           document.getElementById(id_old).style.display='none';
        }
        id_old = id;
        if(display=='none'){
           document.getElementById(id).style.display='table-row';
        }else{
           document.getElementById(id).style.display='none';
        }
      }

      function sh_bus_num(){
        $("#times").html("");
        document.getElementById('tab').style.display='table';
      }

        var a = [];
        var lat = [];
        var lon = [];
        var bus_number;

        function get_number(n){
          $("span").text(n + " bus route");
          document.getElementById('tab').style.display='none';
          bus_number = n;
          get_times('outbound');
        }

        function get_times(way) {
          myMap.geoObjects.removeAll();
          var route = bus_number + '/route/sequence/' + way;
            $.ajax({
                type: 'GET',
                url: 'https://api.tfl.gov.uk/line/' + route,
                dataType: 'json',
                success: function (data) {
                    $("#times").html("");
                    var output = "<div id=stoppoint>";
                    for (var i in data.stopPointSequences) {
                        for (var k in data.stopPointSequences[i].stopPoint) {
                            a[k] = data.stopPointSequences[i].stopPoint[k].id;
                            lat[k] = data.stopPointSequences[i].stopPoint[k].lat;
                            lon[k] = data.stopPointSequences[i].stopPoint[k].lon;
                            pm_line(k, data.stopPointSequences[i].stopPoint[k].name);
                            output += "<div id=name_station onclick= get_stop(" + k + ")>" + data.stopPointSequences[i].stopPoint[k].name + "</div>";
                        }
                    }
                    output += "</div>";
                    document.getElementById("times").innerHTML = output;
                }
            });
        }

        function get_stop(num){
          var num_id = a[num] + '/arrivals';
              $.ajax({
                  type: 'GET',
                  url: 'https://api.tfl.gov.uk/StopPoint/' + num_id,
                  dataType: 'json',
                  success: function (data) {
                      $("#station").html("");
                      var sorted_1 = data.sort(function (a, b) {
                         if (a.timeToStation > b.timeToStation) {
                             return 1;
                         }
                         if (a.timeToStation < b.timeToStation) {
                             return -1;
                         }
                         return 0;
                      })

                      var sorted_2 = data.sort(function (a, b) {
                         if (a.lineName > b.lineName) {
                             return 1;
                         }
                         if (a.lineName < b.lineName) {
                             return -1;
                         }
                         return 0;
                      })

                      var output = "<div>";
                      output += "<p id=time_st_name>" + data[0].stationName + "</p>" + "<br>";
                      pm(num, data[0].stationName);
                      for (var i in data) {
                        time = parseInt(data[i].timeToStation / 60);
                        time < 1 ? time = "due" : time = time + " min";
                        if(i == 0 || data[i].lineName != data[i-1].lineName){
                          output += "<br>" + data[i].lineName  + " : " + " " + time;
                        }else {
                          output += " / " + time;
                        }
                      }
                      output += "</div>";
                      output += "<button id=refresh class='button button-rounded button-highlight' onclick=get_stop(" + num + ")>refresh</button>"
                      document.getElementById("station").innerHTML = output;
                  }
              });
          }

          var myMap
          ymaps.ready(init);
          function init(num){
              myMap = new ymaps.Map("map", {
                    center: [51.5074, 0.0278],
                  zoom: 9
              });
          }

          function pm(num, s){
            myMap.geoObjects.removeAll();
            var myPlacemark = new ymaps.Placemark([lat[num], lon[num]], {
                hintContent: s,
                balloonContent: s
            });
            myMap.geoObjects.add(myPlacemark);
            myMap.setBounds(myMap.geoObjects.getBounds(), {checkZoomRange:true}).then(function(){
              if(myMap.getZoom() > 15) myMap.setZoom(15);
            });
          }

          function pm_line(k, s){
            var myPlacemark1 = new ymaps.Placemark([lat[k], lon[k]], {
                hintContent: s,
                balloonContent: s
            });
            myMap.geoObjects.add(myPlacemark1);
            myMap.setBounds(myMap.geoObjects.getBounds(), {checkZoomRange:true}).then(function(){
              if(myMap.getZoom() > 15) myMap.setZoom(15);
            });
          }

    </script>

</body>
</html>
